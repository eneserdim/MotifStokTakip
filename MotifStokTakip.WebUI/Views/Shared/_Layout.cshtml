@using System.Security.Claims
@using MotifStokTakip.Service.Data
@inject AppDbContext Db

@functions {
    public class LowStockVm
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public int StockQuantity { get; set; }
        public string? Barcode { get; set; }
    }
}

@{
    var isAuth = User?.Identity?.IsAuthenticated ?? false;
    var role = isAuth ? User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role)?.Value : null;
    var userName = isAuth ? (User.Identity?.Name ?? "Kullanıcı") : "";

    var lowCount = 0;
    var lowStocks = new List<LowStockVm>();
    if (isAuth)
    {
        lowCount = Db.Products.Count(p => p.StockQuantity < 5);
        lowStocks = Db.Products
            .Where(p => p.StockQuantity < 5)
            .OrderBy(p => p.StockQuantity)
            .Select(p => new LowStockVm { Id = p.Id, Name = p.Name, StockQuantity = p.StockQuantity, Barcode = p.Barcode })
            .Take(10)
            .ToList();
    }
}

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"] - Motif Otomotiv</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
        .table-responsive {
    overflow-x: auto;
    overflow-y: hidden;            /* dikey scroll yok */
    -webkit-overflow-scrolling: touch; /* iOS’ta akıcı scroll */
  }

  /* Kaydırma görünürlüğünü iyileştir (opsiyonel) */
  .table-responsive::-webkit-scrollbar {
    height: 8px;
  }
  .table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
  }
  .table-responsive::-webkit-scrollbar-thumb {
    background: #cfd8e3;
    border-radius: 4px;
  }
  .table-responsive::-webkit-scrollbar-thumb:hover {
    background: #b7c2d0;
  }

  /* Hücreler tek satır: sağa-sola kaydırarak tamamını gör */
  .table-nowrap th,
  .table-nowrap td {
    white-space: nowrap;
  }

  /* Mobilde yüksekliği arttırmadan butonları sıkı tut */
  @@media (max-width: 576px) {
    .table .btn {
      padding: .25rem .5rem;
      font-size: .825rem;
    }
  }


        :root {
            --sidebar-w: 260px;
            --sidebar-w-collapsed: 76px;
            --sidebar-bg: #0f172a;
            --sidebar-bg-2: #1e293b;
            --text-light: #e2e8f0;
        }

        html, body {
            height: 100%
        }

        /* ----- SOL MENÜ – Masaüstü ----- */
        .app-shell {
            min-height: 100%;
            display: flex
        }

        .sidebar {
            width: var(--sidebar-w);
            min-height: 100vh;
            background: var(--sidebar-bg);
            color: var(--text-light);
            position: sticky;
            top: 0;
            z-index: 1031;
            transition: width .2s ease;
        }

            .sidebar.collapsed {
                width: var(--sidebar-w-collapsed);
            }

        .brand {
            padding: 1rem .875rem;
            display: flex;
            align-items: center;
            gap: .5rem;
            font-weight: 700;
            letter-spacing: .3px
        }

            .brand .logo {
                width: 36px;
                height: 36px;
                border-radius: .75rem;
                background: linear-gradient(135deg,#60a5fa,#a78bfa);
                display: grid;
                place-items: center;
                color: #0f172a;
                font-weight: 800
            }

        .sidebar .nav-section-title {
            padding: .5rem .875rem;
            opacity: .6;
            font-size: .8rem
        }

        .side-link {
            color: var(--text-light);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: .75rem;
            padding: .625rem .875rem;
            border-radius: .5rem;
            margin: .25rem .5rem;
            white-space: nowrap;
        }

            .side-link:hover, .side-link.active {
                background: var(--sidebar-bg-2);
            }

        .side-icon {
            font-size: 1.15rem;
            width: 1.5rem;
            text-align: center
        }

        /* Çökük halde sadece ikon göster */
        .sidebar.collapsed .side-text,
        .sidebar.collapsed .nav-section-title,
        .sidebar.collapsed .brand span {
            display: none
        }

        .sidebar.collapsed .brand {
            justify-content: center
        }

        /* ----- İçerik ve topbar ----- */
        .main {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .topbar {
            position: sticky;
            top: 0;
            z-index: 1030;
            background: #fff;
            border-bottom: 1px solid #e5e7eb;
        }

        .content-body {
            flex: 1 0 auto;
            padding: 18px
        }

        /* ----- Footer ----- */
        .app-footer {
            background: var(--sidebar-bg);
            color: #fff;
        }

            .app-footer .inner {
                min-height: 56px;
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
                padding: 0 16px
            }

        /* ----- Mobil / Tablet ----- */
        @@media (max-width: 991.98px) {
            .sidebar {
                display: none
            }
            /* masaüstü sidebar gizle */
            .main {
                width: 100%
            }
            /* içerik tam genişlik */
        }

        .offcanvas-sidebar {
            width: var(--sidebar-w);
            background: var(--sidebar-bg);
            color: var(--text-light)
        }

            .offcanvas-sidebar .side-link {
                color: var(--text-light)
            }

                .offcanvas-sidebar .side-link:hover {
                    background: var(--sidebar-bg-2)
                }
    </style>
</head>
<body>
    @if (isAuth)
    {
        <div class="app-shell">

            <!-- Desktop Sidebar (collapsible) -->
            <nav id="desktopSidebar" class="sidebar">
                <div class="brand">
                    <div class="logo">MO</div>
                    <span>Motif Otomotiv</span>
                </div>

                <div class="px-2">
                    <a class="side-link @(ViewContext.RouteData.Values["controller"]?.ToString()=="Home"?"active":"")" href="@Url.Action("Index","Home")">
                        <i class="bi bi-speedometer2 side-icon"></i><span class="side-text">Dashboard</span>
                    </a>
                    <a class="side-link @(ViewContext.RouteData.Values["action"]?.ToString()=="LowStock"?"active":"")" href="@Url.Action("LowStock","Products")">
                        <i class="bi bi-thermometer-half side-icon"></i><span class="side-text">Düşük Stok</span>
                    </a>

                    <div class="nav-section-title">Stok</div>
                    <a class="side-link @(ViewContext.RouteData.Values["controller"]?.ToString()=="Products"?"active":"")" href="@Url.Action("Index","Products")">
                        <i class="bi bi-box-seam side-icon"></i><span class="side-text">Ürünler</span>
                    </a>
                    <a class="side-link @(ViewContext.RouteData.Values["controller"]?.ToString()=="RetailPos"?"active":"")" href="@Url.Action("Index","RetailPos")">
                        <i class="bi bi-cash-stack side-icon"></i><span class="side-text">Ürün Satış</span>
                    </a>

                    <div class="nav-section-title">Cari</div>
                    <a class="side-link @(ViewContext.RouteData.Values["controller"]?.ToString()=="Customers"?"active":"")" href="@Url.Action("Index","Customers")">
                        <i class="bi bi-people side-icon"></i><span class="side-text">Cariler</span>
                    </a>
                    <a class="side-link @(ViewContext.RouteData.Values["controller"]?.ToString()=="Vehicles"?"active":"")" href="@Url.Action("Index","Vehicles")">
                        <i class="bi bi-truck-front side-icon"></i><span class="side-text">Araçlar</span>
                    </a>

                    <div class="nav-section-title">Servis</div>
                    <a class="side-link @(ViewContext.RouteData.Values["controller"]?.ToString()=="ServiceOrders"?"active":"")" href="@Url.Action("Index","ServiceOrders")">
                        <i class="bi bi-tools side-icon"></i><span class="side-text">Servis İşlemleri</span>
                    </a>
                    <a class="side-link @(ViewContext.RouteData.Values["controller"]?.ToString()=="Technicians"?"active":"")" href="@Url.Action("Index","Technicians")">
                        <i class="bi bi-person-gear side-icon"></i><span class="side-text">Ustalar</span>
                    </a>

                    @if (role == "Admin")
                    {
                        <div class="nav-section-title">Yönetim</div>
                        <a class="side-link @(ViewContext.RouteData.Values["controller"]?.ToString()=="User"?"active":"")" href="@Url.Action("Index","User")">
                            <i class="bi bi-shield-lock side-icon"></i><span class="side-text">Kullanıcılar</span>
                        </a>
                    }

                    <hr class="border-secondary opacity-25" />
                    <a class="side-link" href="@Url.Action("Logout","Auth")">
                        <i class="bi bi-box-arrow-right side-icon"></i><span class="side-text">Çıkış</span>
                    </a>
                </div>
            </nav>

            <!-- Main -->
            <div class="main">
                <!-- Topbar -->
                <div class="topbar">
                    <nav class="navbar navbar-expand-lg">
                        <div class="container-fluid">

                            <!-- Sidebar toggle (desktop) / Offcanvas toggle (mobile) -->
                            <div class="d-flex align-items-center gap-2">
                                <button id="btnSidebarToggle" class="btn btn-light d-none d-lg-inline-flex" type="button" title="Menüyü daralt/genişlet">
                                    <i class="bi bi-layout-sidebar-inset"></i>
                                </button>

                                <button class="btn btn-light d-inline-flex d-lg-none" type="button"
                                        data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar" aria-controls="mobileSidebar"
                                        title="Menüyü aç">
                                    <i class="bi bi-list"></i>
                                </button>

                                <span class="fw-semibold ms-1">@ViewData["Title"]</span>
                            </div>

                            <div class="d-flex align-items-center ms-auto gap-2">

                                <!-- Bildirim -->
                                <div class="dropdown">
                                    <button class="btn btn-link position-relative text-decoration-none" data-bs-toggle="dropdown">
                                        <i class="bi bi-bell fs-5"></i>
                                        @if (lowCount > 0)
                                        {
                                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">@lowCount</span>
                                        }
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-end shadow p-0" style="width:360px;max-height:420px;overflow:auto;">
                                        <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                                            <div class="fw-semibold">Düşük Stok Uyarıları</div>
                                            <a class="small text-decoration-none" href="@Url.Action("LowStock","Products")">Tümü (@lowCount)</a>
                                        </div>

                                        @if (lowCount == 0)
                                        {
                                            <div class="p-4 text-center text-secondary">Şu an düşük stok uyarısı yok.</div>
                                        }
                                        else
                                        {
                                            <div class="list-group list-group-flush small">
                                                @foreach (var p in lowStocks)
                                                {
                                                    <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                                       href="@Url.Action("Index","Products", new { q = p.Barcode ?? p.Name })">
                                                        <div class="text-truncate" style="max-width:230px;">
                                                            <i class="bi bi-box-seam me-2 text-secondary"></i>@p.Name
                                                        </div>
                                                        <span class="badge bg-danger-subtle text-danger border">@p.StockQuantity</span>
                                                    </a>
                                                }
                                                <div class="p-2">
                                                    <a href="@Url.Action("LowStock","Products")" class="btn btn-sm btn-outline-secondary w-100">Tümünü Gör (@lowCount)</a>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>

                                <!-- Kullanıcı -->
                                <div class="dropdown">
                                    <button class="btn btn-light d-flex align-items-center gap-2" data-bs-toggle="dropdown">
                                        <i class="bi bi-person-circle fs-5"></i><span class="d-none d-sm-inline">@userName</span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><h6 class="dropdown-header">@userName</h6></li>
                                        <li><a class="dropdown-item" href="@Url.Action("Logout","Auth")"><i class="bi bi-box-arrow-right me-2"></i>Çıkış Yap</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </nav>
                </div>

                <!-- İçerik -->
                <main class="content-body">
                    <div class="container-fluid">
                        @* veya container *@
                        @RenderBody()
                    </div>
                </main>

                <!-- Footer -->
                <footer class="app-footer">
                    <div class="inner">
                        Tüm Hakları Saklıdır © @DateTime.Now.Year&nbsp;|&nbsp;
                        Design by <a href="https://codeilla.com.tr/" target="_blank" rel="noopener" class="ms-1 text-white text-decoration-underline">Codeilla Software</a>
                    </div>
                </footer>
            </div>
        </div>

        <!-- Mobile Offcanvas Sidebar -->
        <div class="offcanvas offcanvas-start offcanvas-sidebar" tabindex="-1" id="mobileSidebar" aria-labelledby="mobileSidebarLabel">
            <div class="offcanvas-header">
                <div class="brand w-100">
                    <div class="logo">MO</div><span>Motif Otomotiv</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body pt-0">
                <a class="side-link" href="@Url.Action("Index","Home")"><i class="bi bi-speedometer2 side-icon"></i><span>Dashboard</span></a>
                <a class="side-link" href="@Url.Action("LowStock","Products")"><i class="bi bi-thermometer-half side-icon"></i><span>Düşük Stok</span></a>

                <div class="nav-section-title">Stok</div>
                <a class="side-link" href="@Url.Action("Index","Products")"><i class="bi bi-box-seam side-icon"></i><span>Ürünler</span></a>
                <a class="side-link" href="@Url.Action("Index","RetailPos")"><i class="bi bi-cash-stack side-icon"></i><span>Ürün Satış</span></a>

                <div class="nav-section-title">Cari</div>
                <a class="side-link" href="@Url.Action("Index","Customers")"><i class="bi bi-people side-icon"></i><span>Cariler</span></a>
                <a class="side-link" href="@Url.Action("Index","Vehicles")"><i class="bi bi-truck-front side-icon"></i><span>Araçlar</span></a>

                <div class="nav-section-title">Servis</div>
                <a class="side-link" href="@Url.Action("Index","ServiceOrders")"><i class="bi bi-tools side-icon"></i><span>Servis İşlemleri</span></a>
                <a class="side-link" href="@Url.Action("Index","Technicians")"><i class="bi bi-person-gear side-icon"></i><span>Ustalar</span></a>

                @if (role == "Admin")
                {
                    <div class="nav-section-title">Yönetim</div>
                    <a class="side-link" href="@Url.Action("Index","User")"><i class="bi bi-shield-lock side-icon"></i><span>Kullanıcılar</span></a>
                }

                <hr class="border-secondary opacity-25" />
                <a class="side-link" href="@Url.Action("Logout","Auth")"><i class="bi bi-box-arrow-right side-icon"></i><span>Çıkış</span></a>
            </div>
        </div>
    }

    @if (!isAuth)
    {
        <!-- Yetkisiz sayfalar için sadece body -->
        <div class="container py-4">@RenderBody()</div>
    }

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Desktop collapse toggle + kalıcı tercih
        (function () {
            const sidebar = document.getElementById('desktopSidebar');
            if (!sidebar) return;

            const key = 'motif.sidebar.collapsed';
            const initial = localStorage.getItem(key) === '1';
            if (initial) sidebar.classList.add('collapsed');

            const btn = document.getElementById('btnSidebarToggle');
            if (btn) {
                btn.addEventListener('click', function () {
                    sidebar.classList.toggle('collapsed');
                    localStorage.setItem(key, sidebar.classList.contains('collapsed') ? '1' : '0');
                });
            }
        })();
    </script>

    @RenderSection("Scripts", required: false)

    @if (TempData["ok"] != null || TempData["err"] != null
    || (ViewData.ModelState?.Values.Any(v => v.Errors.Count > 0) ?? false))
    {
        <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index:1080">
            @* Başarılı *@
            @if (TempData["ok"] != null)
            {
                <div id="toast-ok" class="toast text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            @TempData["ok"]
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Kapat"></button>
                    </div>
                </div>
            }

            @* Hata *@
            @if (TempData["err"] != null)
            {
                <div id="toast-err" class="toast text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            @TempData["err"]
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Kapat"></button>
                    </div>
                </div>
            }

            @* ModelState hataları (ilkini göster) *@
            @{
                var firstModelErr = ViewData.ModelState?
                .SelectMany(x => x.Value!.Errors)
                .Select(e => e.ErrorMessage)
                .FirstOrDefault();
            }
            @if (!string.IsNullOrWhiteSpace(firstModelErr))
            {
                <div id="toast-val" class="toast text-bg-warning border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            @firstModelErr
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Kapat"></button>
                    </div>
                </div>
            }
        </div>

        <script>
            (function () {
                // Sayfadaki tüm .table'ları .table-responsive içine sar ve nowrap uygula
                document.querySelectorAll('table.table').forEach(function (tbl) {
                    // Zaten sarılıysa atla
                    if (!tbl.closest('.table-responsive')) {
                        var wrap = document.createElement('div');
                        wrap.className = 'table-responsive';
                        tbl.parentNode.insertBefore(wrap, tbl);
                        wrap.appendChild(tbl);
                    }
                    // Hücreleri tek satır yap (yatay kaydırma için)
                    tbl.classList.add('table-nowrap');
                });
            })();


            (() => {
                const opt = { delay: 3500, autohide: true };
                ["toast-ok", "toast-err", "toast-val"].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) new bootstrap.Toast(el, opt).show();
                });
            })();
        </script>
    }

</body>
</html>
